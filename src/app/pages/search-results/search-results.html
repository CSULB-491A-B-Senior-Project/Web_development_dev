<div class="page-wrapper">
  <!-- Loading spinner -->
  <div *ngIf="loading()" class="loading">
    <div class="spinner"></div>
    <p>Searching...</p>
  </div>

  <!-- Error message -->
  <div *ngIf="error()" class="error-message">
    <p>{{ error() }}</p>
    <button (click)="retrySearch()">Try Again</button>
  </div>

  <!-- Top bar -->
  <header class="toolbar">
    <nav class="tabs" role="tablist">
      <button [class.active]="tab() === 'all'" (click)="setTab('all')">All</button>
      <button [class.active]="tab() === 'albums'" (click)="setTab('albums')">
        Albums
      </button>
      <button [class.active]="tab() === 'artists'" (click)="setTab('artists')">
        Artists
      </button>
      <button [class.active]="tab() === 'users'" (click)="setTab('users')">
        Users
      </button>
      <button [class.active]="tab() === 'reviews'" (click)="setTab('reviews')">
        Reviews
      </button>
    </nav>

    <div class="right-controls">
      <select [(ngModel)]="sortValue">
        <option value="relevance">Relevance</option>
        <option value="recent">Recent</option>
        <option value="popular">Most liked</option>
        <option value="rating">Highest rated</option>
      </select>

      <div class="view-toggle" role="tablist" aria-label="View toggle">
        <button [class.active]="view() === 'grid'"
                (click)="setView('grid')"
                [attr.aria-pressed]="view() === 'grid'">
          Grid
        </button>
        <button [class.active]="view() === 'list'"
                (click)="setView('list')"
                [attr.aria-pressed]="view() === 'list'">
          List
        </button>
      </div>
    </div>
  </header>

  <!-- Meta row -->
  <div class="meta-row">
    <span class="count">{{ resultCount() }} results</span>
    <span *ngIf="tab() !== 'all' && totalPages() > 1" class="page-info">
      Page {{ currentPage() }} of {{ totalPages() }}
    </span>
  </div>
  <!-- GRID VIEW -->
  <div *ngIf="view() === 'grid' && !loading()">
    <!-- ALL TAB: categorized sections -->
    <div *ngIf="tab() === 'all'">
      <section *ngFor="let category of categories()" class="category-section">
        <div class="category-header">
          <h2>{{ category.label }}</h2>
          <span class="category-count">
            {{ category.items.length }} of
            {{ category.count }}
            result{{ category.count !== 1 ? 's' : '' }}
          </span>
        </div>

        <!-- Albums & artists -->
        <div class="cards"
             *ngIf="category.type === 'albums' || category.type === 'artists'">
          <app-explore-card *ngFor="let item of category.items; trackBy: trackById"
                            [username]="item.username"
                            [title]="item.title"
                            [genres]="item.genres"
                            [dateLabel]="item.dateLabel"
                            [imageUrl]="item.imageUrl"
                            [isArtist]="item.isArtist"
                            [favorites]="item.favorites"
                            [rating]="item.rating"
                            [viewLink]="
              category.type === 'albums'
                ? ['/albums', item.id]
                : ['/artists', item.id]
            ">
          </app-explore-card>
        </div>

        <!-- Users -->
        <div class="user-cards" *ngIf="category.type === 'users'">
          <app-user-card *ngFor="let item of category.items; trackBy: trackById"
                         [username]="item.username"
                         [displayName]="item.title"
                         [avatarUrl]="item.imageUrl">
          </app-user-card>
        </div>

        <!-- Reviews -->
        <div class="post-cards" *ngIf="category.type === 'reviews'">
          <app-post-card *ngFor="let item of category.items; trackBy: trackById"
                         [postType]="item.type"
                         [username]="item.username"
                         [albumId]="item.id"
                         [albumTitle]="item.title"
                         [artistName]="item.username"
                         [albumCover]="item.imageUrl"
                         [commentText]="''"
                         [ratingValue]="item.rating"
                         [createdAt]="item.dateLabel">
          </app-post-card>
        </div>
      </section>
    </div>

    <!-- SPECIFIC TABS (albums / artists / users / reviews) -->
    <div *ngIf="tab() !== 'all'">
      <!-- Albums -->
      <div class="cards" *ngIf="tab() === 'albums'">
        <app-explore-card *ngFor="let item of items(); trackBy: trackById"
                          [username]="item.username"
                          [title]="item.title"
                          [genres]="item.genres"
                          [dateLabel]="item.dateLabel"
                          [imageUrl]="item.imageUrl"
                          [isArtist]="false"
                          [favorites]="item.favorites"
                          [rating]="item.rating"
                          [viewLink]="['/albums', item.id]">
        </app-explore-card>
      </div>

      <!-- Artists -->
      <div class="cards" *ngIf="tab() === 'artists'">
        <app-explore-card *ngFor="let item of items(); trackBy: trackById"
                          [username]="item.username"
                          [title]="item.title"
                          [genres]="item.genres"
                          [dateLabel]="item.dateLabel"
                          [imageUrl]="item.imageUrl"
                          [isArtist]="true"
                          [favorites]="item.favorites"
                          [rating]="item.rating"
                          [viewLink]="['/artists', item.id]">
        </app-explore-card>
      </div>

      <!-- Users -->
      <div class="user-cards" *ngIf="tab() === 'users'">
        <app-user-card *ngFor="let item of items(); trackBy: trackById"
                       [username]="item.username"
                       [displayName]="item.title"
                       [avatarUrl]="item.imageUrl">
        </app-user-card>
      </div>

      <!-- Reviews -->
      <div class="post-cards" *ngIf="tab() === 'reviews'">
        <app-post-card *ngFor="let item of items(); trackBy: trackById"
                       [postType]="item.type"
                       [username]="item.username"
                       [albumId]="item.id"
                       [albumTitle]="item.title"
                       [artistName]="item.username"
                       [albumCover]="item.imageUrl"
                       [commentText]="''"
                       [ratingValue]="item.rating"
                       [createdAt]="item.dateLabel">
        </app-post-card>
      </div>

      <!-- Pagination -->
      <!--<div class="pagination" *ngIf="totalPages() > 1">
        <button (click)="previousPage()" [disabled]="currentPage() === 1">
          ‹ Previous
        </button>

        <span class="page-indicator">
          Page {{ currentPage() }} of {{ totalPages() }}
        </span>

        <button (click)="nextPage()" [disabled]="!hasMorePages()">
          Next ›
        </button>
      </div>-->
    </div>
  </div>

  <!-- LIST VIEW (simple text list) -->
  <ul *ngIf="view() === 'list' && !loading()" class="list">
    <li *ngFor="let it of items(); trackBy: trackById" class="row">
      <span>{{ it.title || it.username }}</span>
    </li>
  </ul>

  <!-- Empty state -->
  <div class="empty" *ngIf="!loading() && resultCount() === 0 && query()">
    <img src="/assets/placeholder.jpg" alt="No results" />
    <p *ngIf="tab() === 'all'">No results for "{{ query() }}". Try different keywords.</p>
    <p *ngIf="tab() === 'albums'">No albums found for "{{ query() }}".</p>
    <p *ngIf="tab() === 'artists'">No artists found for "{{ query() }}".</p>
    <p *ngIf="tab() === 'users'">No users found for "{{ query() }}".</p>
    <p *ngIf="tab() === 'reviews'">No posts found for "{{ query() }}".</p>
  </div>
</div>
