<div class="settings-page">
  <app-sidebar [activeSection]="'profile'" (logout)="onLogout()"></app-sidebar>

  <div class="settings-container">
    <!-- PROFILE PICTURE -->
    <h1>Profile Picture</h1>
    <p><b>Show off your best self!</b> Add a photo that makes your profile uniquely yours.</p>
    <div class="profile-picture-container">
      <img
        ngOptimizedImage
        class="profile-picture"
        [ngSrc]="profilePictureUrl() || '/assets/default-profile.png'"
        width="100"
        height="100"
        alt="Current profile picture" />
      <button type="button" class="action-button" (click)="profilePicInput.click()">
        Change Picture
        <input
          #profilePicInput
          type="file"
          accept=".jpg,.png,.jpeg,.webp"
          (change)="onProfilePictureSelected($event)"
          style="display: none;" />
      </button>
      <span class="file-name">
        {{ profilePicFileName() || 'No file selected. Must not exceed 3MB. File types .jpg, .png, .jpeg accepted.' }}
      </span>
    </div>

    <!-- BACKGROUND -->
    <h1>Background</h1>
    <p><b>Set the vibe.</b> Upload an image that brings your profile to life.</p>
    <div class="file-upload-container">
      <div *ngIf="backgroundImageUrl() as bgUrl" style="margin-top: .5rem;">
        <div style="margin-top:.5rem; margin-bottom:.75rem;">
          <img
            ngOptimizedImage
            [ngSrc]="bgUrl"
            width="320"
            height="180"
            alt="Current background image preview"
            style="border-radius:6px;border:1px solid #333;" />
        </div>
      </div>

      <button type="button" class="custom-upload-button" (click)="fileInput.click()">
        <span>Upload</span>
        <input
          #fileInput
          type="file"
          accept=".jpg,.png,.jpeg"
          (change)="onFileSelected($event)"
          style="display: none;" />
      </button>
      <span class="file-name">
        {{ selectedFileName() || 'No file selected. Must not exceed 5MB. File types .jpg, .png, .jpeg accepted.' }}
      </span>
    </div>

    <!-- BIO -->
    <h1>About Me</h1>
    <p><b>Tell your story.</b> Share a short bio so others can get to know the real you.</p>
    <form [formGroup]="bioForm" (ngSubmit)="onBioSubmit()" class="bio-form">
      <div class="textarea-wrapper">
        <textarea
          #bioTextarea
          (input)="autoResizeBio()"
          formControlName="bio"
          maxlength="150"
          rows="1"
          class="expanding-textarea"></textarea>
        <small class="char-count">{{ (bioForm.value.bio || '').length }}/150 characters</small>
      </div>
      <button type="submit" [disabled]="bioForm.pristine || bioForm.invalid">Save Bio</button>
    </form>

    <!-- FAVORITE SONG -->
    <h1>Favorite Song</h1>
    <p><b>Pick your anthem.</b> Feature the track that represents your mood or style.</p>
    <ng-container *ngIf="favoriteSong() as song; else songSearchBlock">
      <div class="favorite-song-card">
        <img
          ngOptimizedImage
          class="item-cover"
          [ngSrc]="song.albumCoverUrl || song.albumCover || placeholderAlbum"
          width="60"
          height="60"
          [alt]="song.name" />
        <div class="item-meta">
          <div class="item-title">{{ song.name }}</div>
          <div class="item-sub">{{ song.artistName }}</div>
        </div>
        <button type="button" class="clear-btn" (click)="clearFavoriteSong()">âœ•</button>
      </div>
    </ng-container>

    <ng-template #songSearchBlock>
      <!-- SONG SEARCH -->
      <form [formGroup]="songSearchForm" class="search-container">
        <input class="form-control" type="text" formControlName="query" placeholder="Search for a song..." />
        <ul class="search-results" *ngIf="songSearchQuery() && songResults().length > 0">
          <li class="result-item" *ngFor="let s of songResults(); trackBy: trackBySong" (click)="selectSong(s)">
            <img
              ngOptimizedImage
              [ngSrc]="s.albumCoverUrl || s.albumCover || placeholderAlbum"
              width="50"
              height="50"
              class="item-image"
              [alt]="s.name" />
            <div class="item-meta">
              <span class="item-title">{{ s.name }}</span>
              <span class="item-sub">{{ s.artistName }}</span>
            </div>
          </li>
        </ul>
        <!-- Loading statement for song search -->
        @if (loadingSongSearch()) {
          <div class="search-loading">Searching songs...</div>
        }
        @if (songSearchError()) {
          <div class="search-error">{{ songSearchError() }}</div>
        }
        @if (
          songSearchQuery() &&
          !loadingSongSearch() &&
          songResults().length === 0 &&
          !songSearchError() &&
          !songSearchForm.pristine
        ) {
          <div class="search-empty">No songs found matching "{{ songSearchQuery() }}"</div>
        }
      </form>
    </ng-template>

     <!-- ARTISTS -->
    <h1>Top 10 Artists</h1>
    <p><b>Rank your icons.</b> Celebrate the artists who inspire you most.</p>
    
    <!-- Search for followed artists to add to favorites -->
    <form 
      [formGroup]="followedArtistSearchForm" 
      class="search-container"
      (focusout)="handleFollowedArtistSearchFocusOut($event)"
    >
      <input 
        class="form-control" 
        type="text" 
        formControlName="query" 
        placeholder="Search your followed artists to add to favorites..."
        (focus)="showFollowedArtistResults.set(true)"
      />
      @if (showFollowedArtistResults() && followedArtistSearchQuery() && followedArtistResults().length > 0) {
        <ul class="search-results">
          @for (artist of followedArtistResults(); track artist.id) {
            <li class="result-item">
              <img
                ngOptimizedImage
                [ngSrc]="artist.artistImage || placeholderArtist"
                width="50"
                height="50"
                class="item-image"
                [alt]="artist.artistName" 
              />
              <div class="item-meta">
                <span class="item-title">{{ artist.artistName }}</span>
                <span class="item-sub">Artist</span>
              </div>
              <button 
                type="button" 
                class="heart-btn"
                [class.hearted]="isArtistFavorited(artist.id)"
                [disabled]="isArtistFavorited(artist.id)"
                (click)="heartFollowedArtist(artist)"
                [attr.aria-pressed]="isArtistFavorited(artist.id)"
                [title]="isArtistFavorited(artist.id) ? 'Already in favorites' : 'Add to favorites'"
              >
                <i 
                  class="fa-heart"
                  [class.fa-solid]="isArtistFavorited(artist.id)"
                  [class.fa-regular]="!isArtistFavorited(artist.id)"
                  aria-hidden="true"
                ></i>
                <span class="visually-hidden">
                  {{ isArtistFavorited(artist.id) ? 'Remove from favorites' : 'Add to favorites' }}
                </span>
              </button>
            </li>
          }
        </ul>
      }
      @if (loadingFollowedArtistSearch()) {
        <div class="search-loading">Searching followed artists...</div>
      }
      @if (followedArtistSearchError()) {
        <div class="search-error">{{ followedArtistSearchError() }}</div>
      }
      @if (showFollowedArtistResults() && followedArtistSearchQuery() && !loadingFollowedArtistSearch() && followedArtistResults().length === 0) {
        <div class="search-empty">No followed artists found matching "{{ followedArtistSearchQuery() }}"</div>
      }
    </form>

    <div
      cdkDropList
      (cdkDropListDropped)="dropFavoriteArtist($event)"
      class="artist-rank-list"
    >
      <ng-container *ngIf="topTenFavoriteArtistsListArr.length; else artistsEmpty">
        <div
          *ngFor="let artist of topTenFavoriteArtistsListArr; let i = index; trackBy: trackByArtist"
          class="artist-rank-item"
          cdkDrag
        >
          
          <span class="rank-number">{{ getArtistRank(artist.id, i + 1) }}</span>
          
          <img ngOptimizedImage [ngSrc]="artist.artistImage || placeholderArtist" width="48" height="48" [alt]="artist.artistName || 'Artist image'" />
          <span class="artist-name">{{ artist.artistName || 'Unknown artist' }}</span>

          <!-- NEW: heart button to remove from favorites -->
          <button
            type="button"
            class="heart-btn"
            (click)="$event.stopPropagation(); removeArtistFromFavorites(artist)"
            [attr.aria-pressed]="true"
            title="Remove from favorites"
            [class.hearted]="true">
            <i class="fa-heart fa-solid" aria-hidden="true"></i>
            <span class="visually-hidden">Remove favorite</span>
          </button>

          <span class="drag-handle" cdkDragHandle aria-label="Drag handle">â‹®â‹®</span>
        </div>
      </ng-container>

      <ng-template #artistsEmpty>
        <div class="empty-list-text">
          <div class="empty-icon">ðŸŽ§</div>
          <div class="empty-title">No favorite artists to rank</div>
          <div class="empty-sub">Favorite artists to build your top 10. Changes save automatically.</div>
        </div>
      </ng-template>
    </div>

    <!-- FAVORITE ALBUMS -->
    <div class="favorites-section album-favorites">
      <h1>Favorite Albums</h1>
      <p><b>Heart what you love.</b> Showcase the albums that define your taste.</p>

      <!-- ALBUM SEARCH -->
      <form [formGroup]="albumSearchForm" class="search-container">
        <input
          type="text"
          class="form-control"
          [formControl]="albumSearchForm.controls.query"
          placeholder="Search for albums..."
        />
        <ul class="search-results" *ngIf="albumSearchQuery() && albumResults().length > 0">
          <li class="result-item" *ngFor="let album of albumResults(); trackBy: trackByAlbum">
            <img ngOptimizedImage [ngSrc]="album.albumCover || placeholderAlbum" class="item-image" width="50" height="50" [alt]="album.name || 'Album cover'" />
            <div class="item-meta">
              <span class="item-title">{{ album.name || 'Unknown album' }}</span>
              <span class="item-sub">{{ album.artist?.artistName ?? '' }}{{ album.releaseYear ? ' â€¢ ' + album.releaseYear : '' }}</span>
            </div>
            <button
              type="button"
              class="heart-btn"
              (click)="$event.stopPropagation(); addAlbumToFavorites(album)"
              [attr.aria-pressed]="false"
              [title]="'Add to favorites'">
              <i class="fa-heart fa-regular" aria-hidden="true"></i>
              <span class="visually-hidden">Add favorite</span>
            </button>
          </li>
        </ul>
        <!-- Loading statement for album search -->
        @if (loadingAlbumSearch()) {
          <div class="search-loading">Searching albums...</div>
        }
        @if (albumSearchError()) {
          <div class="search-error">{{ albumSearchError() }}</div>
        }
        @if (albumSearchQuery() && !loadingAlbumSearch() && albumResults().length === 0) {
          <div class="search-empty">No albums found matching "{{ albumSearchQuery() }}"</div>
        }
      </form>

        <div class="selection-list album-list" *ngIf="favoriteAlbums().length; else albumsEmpty">
          <div *ngFor="let album of favoriteAlbums(); trackBy: trackByAlbum" class="selection-item" [class.unhearted]="isAlbumUnhearted(album)">
            <img ngOptimizedImage [ngSrc]="album.albumCover || placeholderAlbum" class="item-image" width="50" height="50" [alt]="album.name || 'Album cover'" />
            <div class="item-meta">
              <span class="item-title">{{ album.name || 'Unknown album' }}</span>
              <span class="item-sub">{{ album.artist?.artistName ?? '' }}{{ album.releaseYear ? ' â€¢ ' + album.releaseYear : '' }}</span>
            </div>
            <button
              type="button"
              class="heart-btn"
              (click)="isAlbumUnhearted(album) ? addAlbumToFavorites(album) : removeAlbumFromFavorites(album)"
              [attr.aria-pressed]="!isAlbumUnhearted(album)"
              [title]="isAlbumUnhearted(album) ? 'Add to favorites' : 'Remove from favorites'"
              [class.hearted]="!isAlbumUnhearted(album)"
              [class.unhearted]="isAlbumUnhearted(album)">
              <ng-container *ngIf="!isAlbumUnhearted(album); else unheartedIcon">
                <i class="fa-heart fa-solid" aria-hidden="true"></i>
                <span class="visually-hidden">Remove favorite</span>
              </ng-container>
              <ng-template #unheartedIcon>
                <i class="fa-heart fa-regular" aria-hidden="true"></i>
                <span class="visually-hidden">Add favorite</span>
              </ng-template>
            </button>
          </div>
        </div>

        <ng-template #albumsEmpty>
          <div class="selection-list album-list">
            <div class="empty-list-text">
              <div class="empty-icon">ðŸ’¿</div>
              <div class="empty-title">No favorite albums yet</div>
              <div class="empty-sub">Search above and heart albums to add them. Click again to remove.</div>
            </div>
          </div>
        </ng-template>
      </div>
    </div>
</div>
