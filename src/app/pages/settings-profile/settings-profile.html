<body>
  <div class="settings-sidebar">
    <a class="logo" routerLink="/explore"><img src="/assets/crescendo-logo-no-text.png" /></a>
    <h1>Settings</h1>
    <h2 class="active">Edit Profile</h2>
    <h2><a routerLink="/settings-account">Account</a></h2>
    <button class="logout" (click)="onLogout()">Logout</button>
  </div>

  <div class="settings-container">
    <!-- PROFILE PICTURE -->
    <h1>Profile Picture</h1>
    <p>Upload a new photo for your profile.</p>
    <div class="profile-picture-container">
      <!-- Use NgOptimizedImage and [ngSrc] to match the signal -->
      <img
        ngOptimizedImage
        class="profile-picture"
        [ngSrc]="profilePictureUrl() || '/assets/default-profile.png'"
        width="100"
        height="100"
        alt="Current profile picture" />
      <button type="button" class="action-button" (click)="profilePicInput.click()">
        Change Picture
        <input
          #profilePicInput
          type="file"
          accept=".jpg,.png,.jpeg,.webp"
          (change)="onProfilePictureSelected($event)"
          style="display: none;" />
      </button>
      <span class="file-name">
        {{ profilePicFileName() || 'No file selected. Must not exceed 3MB. File types .jpg, .png, .jpeg accepted.' }}
      </span>
    </div>

    <!-- BACKGROUND -->
    <h1>Background</h1>
    <p>Upload a new image to personalize your profile background.</p>
    <div class="file-upload-container">
      <button type="button" class="custom-upload-button" (click)="fileInput.click()">
        <span>Upload</span>
        <input
          #fileInput
          type="file"
          accept=".jpg,.png,.jpeg"
          (change)="onFileSelected($event)"
          style="display: none;" />
      </button>
      <span class="file-name">
        {{ selectedFileName() || 'No file selected. Must not exceed 5MB. File types .jpg, .png, .jpeg accepted.' }}
      </span>
    </div>

    <!-- BIO -->
    <h1>About Me</h1>
    <p>Share a short bio to let others know who you are.</p>
    <form [formGroup]="bioForm" (ngSubmit)="onBioSubmit()" class="bio-form">
      <div class="textarea-wrapper">
        <textarea
          #bioTextarea
          (input)="autoResizeBio()"
          formControlName="bio"
          maxlength="150"
          rows="1"
          class="expanding-textarea"></textarea>

        <ng-container *ngIf="bioForm.get('bio') as bio">
          <small class="char-count">{{ (bio.value || '').toString().length }}/150 characters</small>
        </ng-container>
      </div>
      <button type="submit" [disabled]="bioForm.pristine || bioForm.invalid">Save Bio</button>
    </form>

    <!-- SELECT MUSIC -->
    <h1>Select music</h1>
    <p>Choose a favorite song to feature on your profile.</p>

    <ng-container *ngIf="favoriteSong() as song; else songSearchBlock">
      <div class="favorite-song-card">
        <img ngOptimizedImage class="item-cover" [ngSrc]="song.albumCover || placeholderAlbum" width="60" height="60" [alt]="song.name || 'Song cover'" />
        <div class="item-meta">
          <div class="item-title">{{ song.name || 'Unknown song' }}</div>
          <div class="item-sub">{{ song.artistName || '' }}</div>
        </div>
        <button type="button" class="clear-btn" (click)="clearFavoriteSong()" title="Clear selection">âœ•</button>
      </div>
    </ng-container>

    <ng-template #songSearchBlock>
      <form [formGroup]="songSearchForm" class="search-container">
        <input
          class="form-control"
          type="text"
          formControlName="query"
          placeholder="Search for a song..." />
        <ul class="search-results" *ngIf="songSearchQuery() && songResults().length > 0">
          <li class="result-item" *ngFor="let s of songResults(); trackBy: trackBySong" (click)="selectSong(s)">
            <img ngOptimizedImage [ngSrc]="s.albumCover || placeholderAlbum" class="item-image" width="50" height="50" [alt]="s.name || 'Song cover'" />
            <div class="item-meta">
              <span class="item-title">{{ s.name || 'Unknown song' }}</span>
              <span class="item-sub">{{ s.artistName || '' }}</span>
            </div>
          </li>
        </ul>
      </form>
    </ng-template>

    <!-- FAVORITE ARTISTS -->
    <div class="favorites-section">
      <h1>Rank top 10 favorite artists</h1>
      <p>Drag to reorder. Changes save automatically.</p>

      <div
        cdkDropList
        (cdkDropListDropped)="dropFavoriteArtist($event)"
        class="artist-rank-list">

        <div *ngFor="let artist of topTenFavoriteArtistsListArr; let i = index; trackBy: trackByArtist" class="artist-rank-item" cdkDrag>
          <span class="rank-number">{{ i + 1 }}</span>
          <img ngOptimizedImage [ngSrc]="artist.artistImage || placeholderArtist" width="48" height="48" [alt]="artist.artistName || 'Artist image'" />
          <span class="artist-name">{{ artist.artistName || 'Unknown artist' }}</span>
          <span class="drag-handle" cdkDragHandle aria-label="Drag handle">â‹®â‹®</span>
        </div>

        <div *ngIf="(topTenFavoriteArtistsListArr || []).length === 0" class="artist-rank-list">
          <div class="empty-list-text">
            <div class="empty-icon">ðŸŽ§</div>
            <div class="empty-title">No favorite artists to rank</div>
            <div class="empty-sub">Favorite artists to build your top 10. Changes save automatically.</div>
          </div>
        </div>
      </div>
    </div>

    <!-- FAVORITE ALBUMS -->
    <div class="favorites-section album-favorites">
      <h1>Edit favorite albums</h1>
      <p>Heart albums to add them. Click again to remove.</p>

      <form [formGroup]="albumSearchForm" class="search-container">
        <input
          class="form-control"
          type="text"
          formControlName="query"
          placeholder="Search for albums to add..." />
        <ul class="search-results" *ngIf="albumSearchQuery() && albumResults().length > 0">
          <li class="result-item" *ngFor="let album of albumResults(); trackBy: trackByAlbum">
            <img ngOptimizedImage [ngSrc]="album.albumCover || placeholderAlbum" class="item-image" width="50" height="50" [alt]="album.name || 'Album cover'" />
            <div class="item-meta">
              <span class="item-title">{{ album.name || 'Unknown album' }}</span>
              <span class="item-sub">{{ album.artist?.artistName ?? '' }}{{ album.releaseYear ? ' â€¢ ' + album.releaseYear : '' }}</span>
            </div>
            <button
              type="button"
              class="heart-btn"
              (click)="$event.stopPropagation(); addAlbumToFavorites(album)"
              [attr.aria-pressed]="false"
              [title]="'Add to favorites'">
              <i class="fa-heart fa-regular" aria-hidden="true"></i>
              <span class="visually-hidden">Add favorite</span>
            </button>
          </li>
        </ul>
      </form>

      <div class="selection-list album-list">
        <div *ngFor="let album of favoriteAlbums(); trackBy: trackByAlbum" class="selection-item" [class.unhearted]="isAlbumUnhearted(album)">
          <img ngOptimizedImage [ngSrc]="album.albumCover || placeholderAlbum" class="item-image" width="50" height="50" [alt]="album.name || 'Album cover'" />
          <div class="item-meta">
            <span class="item-title">{{ album.name || 'Unknown album' }}</span>
            <span class="item-sub">{{ album.artist?.artistName ?? '' }}{{ album.releaseYear ? ' â€¢ ' + album.releaseYear : '' }}</span>
          </div>
          <button
            type="button"
            class="heart-btn"
            (click)="isAlbumUnhearted(album) ? addAlbumToFavorites(album) : removeAlbumFromFavorites(album)"
            [attr.aria-pressed]="!isAlbumUnhearted(album)"
            [title]="isAlbumUnhearted(album) ? 'Add to favorites' : 'Remove from favorites'"
            [class.hearted]="!isAlbumUnhearted(album)"
            [class.unhearted]="isAlbumUnhearted(album)">
            <ng-container *ngIf="!isAlbumUnhearted(album); else unheartedIcon">
              <i class="fa-heart fa-solid" aria-hidden="true"></i>
              <span class="visually-hidden">Remove favorite</span>
            </ng-container>
            <ng-template #unheartedIcon>
              <i class="fa-heart fa-regular" aria-hidden="true"></i>
              <span class="visually-hidden">Add favorite</span>
            </ng-template>
          </button>
        </div>

        <div *ngIf="(favoriteAlbums() || []).length === 0" class="album-favorites">
          <div class="selection-list album-list">
            <div class="empty-list-text">
              <div class="empty-icon">ðŸ’¿</div>
              <div class="empty-title">No favorite albums yet</div>
              <div class="empty-sub">Search above and heart albums to add them. Click again to remove.</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</body>
